---
/*
  eslint-disable
  @typescript-eslint/no-unsafe-member-access,
  @typescript-eslint/no-unsafe-assignment,
  @typescript-eslint/no-unsafe-return,
  @typescript-eslint/no-unsafe-call,
  @typescript-eslint/no-explicit-any,
  @typescript-eslint/restrict-template-expressions
*/
import { DateTime } from "luxon";

import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";
import map from "../assets/map.png";

// FIXME: Please add type for the result
const result = await fetch(
  "https://meteo.gc.ca/api/app/v3/fr/Location/45.529,-73.562?type=city",
)
  .then((x) => x.json())
  .then((x: any) => x[0]);

import radarLayer from "../assets/generated/downloaded-radar.png";

const generatedAt = DateTime.now()
  .setZone("America/Toronto")
  .setLocale("fr")
  .toLocaleString(DateTime.DATETIME_MED_WITH_WEEKDAY);

const showHumidex = result.hourlyFcst.hourly.some((x: any) =>
  Boolean(x.feelsLike.metric),
);
---

<Layout title="Météo Montréal">
  <h1>{result.observation.observedAt}</h1>
  <p>Cette page a été généré le {generatedAt}</p>

  <hr />

  <h2>Observation</h2>
  <p>Faite à {result.observation.timeStampText}</p>

  <dl>
    <dt>Condition</dt>
    <dd>{result.observation.condition}</dd>

    <dt>Température</dt>
    <dd>{result.observation.temperature.metric} °C</dd>

    <dt>Humidex</dt>
    <dd>{result.observation.feelsLike.metric} °C</dd>

    <dt>Humidité</dt>
    <dd>{result.observation.humidity}%</dd>

    <dt>Vent</dt>
    <dd>
      {result.observation.windDirection}
      {result.observation.windSpeed.metric} km/h{
        result.observation.windGust.metric
          ? ` avec rafales
     à ${result.observation.windGust.metric} km/h`
          : ""
      }
    </dd>
  </dl>

  <hr />

  <h2>Radar</h2>

  <div class="radar">
    <Image class="layer" alt="Couche radar" src={radarLayer} />

    <!-- Image from: https://ows.terrestris.de/osm/service?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&BBOX=43.256666847747745,-76.77304180512725,47.761171352252255,-70.34536499487275&CRS=EPSG:4326&WIDTH=600&HEIGHT=600&LAYERS=OSM-WMS-no-labels&FORMAT=image/png&STYLES= -->
    <Image
      class="map"
      alt="La carte the 2500km par 2500km avec Montreal au centre."
      src={map}
    />
  </div>

  <hr />

  <h2>Prévision horaire</h2>

  <div
    class="table-wrapper"
    tabindex="0"
    role="region"
    aria-labelledby="tableCaption_01"
  >
    <table>
      <caption id="tableCaption_01">
        Prévision horaire pour les {result.hourlyFcst.hourly.length} prochaines heures.
      </caption>
      <thead>
        <tr>
          <td>Horaire</td>
          <td>°C</td>
          {showHumidex && <td>Humidex</td>}
          <td>Condition</td>
          <td>Prob. d'averse</td>
        </tr>
      </thead>
      <tbody>
        {
          result.hourlyFcst.hourly.map((x: any, index: number) => {
            const addDate = index === 0 || x.time === "0h00";

            return (
              <>
                {addDate && (
                  <tr>
                    <td colspan="5">{x.date}</td>
                  </tr>
                )}
                <tr>
                  <td>{x.time}</td>
                  <td>{x.temperature.metric} °C</td>
                  {showHumidex && <td>{x.feelsLike.metric} °C</td>}
                  <td>{x.condition}</td>
                  <td>{x.precip}%</td>
                </tr>
              </>
            );
          })
        }
      </tbody>
    </table>
  </div>
</Layout>

<style>
  .radar {
    position: relative;
  }

  .layer {
    position: absolute;
    top: 0;
    left: 0;
  }
</style>
